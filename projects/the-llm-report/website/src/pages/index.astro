---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const allEditions = await getCollection('editions');
const editions = allEditions
  .sort((a, b) => b.data.date.localeCompare(a.data.date))
  .map(entry => {
    const wordCount = entry.body.split(/\s+/).length;
    const readTime = Math.max(1, Math.round(wordCount / 200)) + ' min';
    const storyCount = (entry.body.match(/^## /gm) || []).length || null;
    return {
      slug: entry.slug,
      date: entry.data.date,
      title: entry.data.title,
      description: entry.data.description || '',
      readTime,
      storyCount,
    };
  });

const latest = editions[0];
const past = editions.slice(1);

// Parse date strings as noon UTC to avoid timezone day-shift on any server
const parseDate = (d: string) => new Date(d + 'T12:00:00Z');

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  'name': 'The LLM Report',
  'url': 'https://thellmreport.com',
  'description': 'Autonomous AI industry intelligence. 4x per week.',
};
---

<Base
  title="The LLM Report"
  description="Autonomous AI industry intelligence. Journalist-quality coverage of model releases, API updates, and frameworks â€” Monday, Wednesday, Friday, Saturday."
  jsonLd={jsonLd}
>
  <div class="container">

    <!-- Hero -->
    <section class="hero">
      <p class="hero-eyebrow">AI Industry Intelligence</p>
      <h1 class="hero-title">What matters in AI,<br>without the noise.</h1>
      <p class="hero-tagline">
        Journalist-quality coverage of model releases, APIs, and infrastructure.
        Produced autonomously, published 4&times; per week.
      </p>

      <form
        class="subscribe-form"
        action="https://buttondown.com/api/emails/embed-subscribe/thellmreport"
        method="post"
        target="popupwindow"
        onsubmit="window.open('https://buttondown.com/thellmreport','popupwindow')"
      >
        <input
          type="email"
          name="email"
          placeholder="your@email.com"
          required
          autocomplete="email"
        />
        <button type="submit">Subscribe free</button>
      </form>
      <p class="subscribe-note">Free &middot; 4&times; per week &middot; No spam &middot; Unsubscribe anytime</p>
    </section>

    <!-- Latest edition -->
    {latest && (
      <div>
        <div class="section-header">
          <h2>Latest edition</h2>
        </div>
        <a href={`/editions/${latest.slug}`} class="featured-edition">
          <div class="featured-edition-eyebrow">
            {parseDate(latest.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' })}
            {latest.storyCount && <span>&nbsp;&middot; {latest.storyCount} stories</span>}
          </div>
          <div class="featured-edition-title">{latest.title}</div>
          {latest.description && (
            <div class="featured-edition-desc">{latest.description}</div>
          )}
          <div class="featured-edition-footer">
            {latest.readTime && <span class="read-time">{latest.readTime} read</span>}
            <span class="edition-cta">Read this edition &rarr;</span>
          </div>
        </a>
      </div>
    )}

    {!latest && (
      <div style="padding: 2rem 0;">
        <p class="text-muted">First edition publishing Friday, February 28.</p>
      </div>
    )}

    <!-- Past editions -->
    {past.length > 0 && (
      <div style="margin-top: 2.5rem;">
        <div class="section-header">
          <h2>Past editions</h2>
          <a href="/archive">All editions &rarr;</a>
        </div>
        <ul class="edition-list">
          {past.map(ed => (
            <li>
              <a href={`/editions/${ed.slug}`} class="edition-card">
                <div>
                  <div class="edition-card-title">{ed.title}</div>
                  {ed.description && (
                    <div class="text-xs text-muted mt-1">{ed.description}</div>
                  )}
                </div>
                <div class="edition-card-meta">
                  {ed.readTime && <span class="read-time">{ed.readTime}</span>}
                  <span>{parseDate(ed.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' })}</span>
                </div>
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Sponsor slot -->
    <div class="sponsor-slot"></div>

  </div>
</Base>
